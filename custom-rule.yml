rules:
  # =========================================================
  # A. DATABASE & INJECTION
  # =========================================================

  - id: org-go-sqli-concat
    message: "Possible SQL injection: query built with string concatenation. Use parameterized queries (placeholders) instead."
    languages: [go]
    severity: ERROR
    patterns:
      - pattern: |
          $DB.Query("..."+$X+"...", ...)
      - pattern-inside: |
          func $F(...){ ... }
      - metavariable-pattern:
          metavariable: $X
          pattern-regex: "(?i)(FormValue|Query\\(|PostForm|Param|Header|Body|JSON|Bind|RequestURI)"
    paths:
      include: ["**/*.go"]
      exclude: ["**/vendor/**","**/generated/**","**/migrations/**","**/*_test.go"]

  - id: org-go-db-require-context
    message: "Database calls should use context-aware methods (QueryContext/ExecContext) to support timeouts/cancellation."
    languages: [go]
    severity: WARNING
    pattern-either:
      - pattern: $DB.Query($Q, ...)
      - pattern: $DB.Exec($Q, ...)
    pattern-not: $DB.*Context($Q, ...)
    paths:
      include: ["**/*.go"]
      exclude: ["**/vendor/**","**/*_test.go"]

  # Heuristic: IDOR â€” akses by :id tanpa ownership check di handler
  - id: org-go-idor-missing-owner-check
    message: "Potential IDOR: route uses resource ID without explicit ownership check (e.g., CheckOwner/IsOwner)."
    languages: [go]
    severity: WARNING
    patterns:
      - pattern-inside: |
          func $H($A ...){ ... }
      - pattern: $R.Param("id")
      - pattern-either:
          - pattern: $DB.Query("...WHERE id = ...", ...)
          - pattern: $DB.QueryRow("...WHERE id = ...", ...)
          - pattern: $DB.Exec("...WHERE id = ...", ...)
    pattern-not: CheckOwner(...)
    paths:
      include: ["**/*.go"]
      exclude: ["**/vendor/**","**/*_test.go","**/migrations/**"]

  # =========================================================
  # B. AUTH / JWT
  # =========================================================

  - id: org-go-jwt-hardcoded-secret
    message: "JWT signed with hardcoded secret. Load from secret manager / env."
    languages: [go]
    severity: ERROR
    patterns:
      - pattern: jwt.NewWithClaims(jwt.SigningMethodHS256, $CLAIMS)
      - pattern-inside: |
          func $F(...){
            ...
            $T.SignedString([]byte($S))
            ...
          }
      - metavariable-pattern:
          metavariable: $S
          pattern-regex: '^".{8,}"$'
    paths:
      include: ["**/*.go"]
      exclude: ["**/vendor/**","**/*_test.go"]

  - id: org-go-gin-auth-middleware-missing
    message: "Sensitive route appears without explicit Auth middleware (heuristic). Ensure router group uses Auth()."
    languages: [go]
    severity: INFO
    patterns:
      - pattern: $R.$METHOD("/admin"..., $H)
    pattern-not-inside: |
      $G := $R.Group("...", ...); 
      $G.Use(Auth(...)); 
      ...
    metavariable-pattern:
      - metavariable: $METHOD
        pattern-regex: "(GET|POST|PUT|PATCH|DELETE)"
    paths:
      include: ["**/*.go"]
      exclude: ["**/vendor/**","**/*_test.go"]

  # =========================================================
  # C. CRYPTO & SECRET HANDLING
  # =========================================================

  - id: org-go-insecure-rand
    message: "Insecure RNG for security token. Use crypto/rand instead of math/rand."
    languages: [go]
    severity: ERROR
    pattern-either:
      - pattern: rand.Int()
      - pattern: rand.Intn(...)
      - pattern: rand.Read(...)
    pattern-inside: |
      import "math/rand"
    paths:
      include: ["**/*.go"]
      exclude: ["**/vendor/**","**/*_test.go"]

  - id: org-go-weak-hash-md5-sha1
    message: "Weak hash for password/secret (md5/sha1). Use bcrypt/argon2 or SHA-256/HMAC where appropriate."
    languages: [go]
    severity: ERROR
    pattern-either:
      - pattern: md5.Sum(...)
      - pattern: sha1.Sum(...)
    paths:
      include: ["**/*.go"]
      exclude: ["**/vendor/**","**/*_test.go"]

  - id: org-go-aes-ecb-cbc-insecure
    message: "Insecure/legacy cipher mode or IV misuse. Prefer AES-GCM or ChaCha20-Poly1305."
    languages: [go]
    severity: WARNING
    pattern-either:
      - pattern: cipher.NewCBCEncrypter($B, $IV)
      - pattern: cipher.NewCBCDecrypter($B, $IV)
      - pattern: cipher.NewCFBEncrypter($B, $IV)
      - pattern: cipher.NewCFBDecrypter($B, $IV)
    paths:
      include: ["**/*.go"]
      exclude: ["**/vendor/**","**/*_test.go"]

  - id: org-go-secret-compare-non-constant-time
    message: "Secret compared with '==' or bytes.Equal. Use crypto/subtle.ConstantTimeCompare."
    languages: [go]
    severity: WARNING
    pattern-either:
      - pattern: $A == $B
      - pattern: bytes.Equal($A, $B)
    metavariable-pattern:
      - metavariable: $A
        pattern-regex: "(?i)(secret|token|signature|mac|hmac|apikey)"
      - metavariable: $B
        pattern-regex: "(?i)(secret|token|signature|mac|hmac|apikey)"
    paths:
      include: ["**/*.go"]
      exclude: ["**/vendor/**","**/*_test.go"]

  # =========================================================
  # D. SENSITIVE DATA & LOGGING / ERROR
  # =========================================================

  - id: org-go-log-sensitive-data
    message: "Sensitive data printed to logs. Mask PII/PAN/password/OTP."
    languages: [go]
    severity: WARNING
    patterns:
      - pattern-either:
          - pattern: log.Printf("...", $X, ...)
          - pattern: log.Println($X, ...)
          - pattern: fmt.Printf("...", $X, ...)
          - pattern: fmt.Println($X, ...)
      - metavariable-pattern:
          metavariable: $X
          pattern-regex: "(?i)(password|passwd|pin|otp|cvv|card|pan|secret|token)"
    paths:
      include: ["**/*.go"]
      exclude: ["**/vendor/**","**/*_test.go"]

  - id: org-go-expose-internal-error-to-client
    message: "Leaking internal error to HTTP response. Return generic message and log details internally."
    languages: [go]
    severity: WARNING
    pattern-either:
      - pattern: http.Error($W, $ERR.Error(), ...)
      - pattern: fmt.Fprintf($W, "...", $ERR)
      - pattern: $ENCODER.Encode($ERR)
    metavariable-pattern:
      - metavariable: $ERR
        pattern-regex: "(?i)(err|error)"
      - metavariable: $W
        pattern-regex: "(?i)(w|writer)"
    paths:
      include: ["**/*.go"]
      exclude: ["**/vendor/**","**/*_test.go"]

  # =========================================================
  # E. FILE/NETWORK MISUSE
  # =========================================================

  - id: org-go-path-traversal
    message: "Potential path traversal. Validate and normalize user-controlled paths."
    languages: [go]
    severity: ERROR
    patterns:
      - pattern: filepath.Join($BASE, $P)
      - metavariable-pattern:
          metavariable: $P
          pattern-regex: "(?i)(FormValue|Query\\(|PostForm|Param|Header|Body|JSON|Bind|RequestURI)"
    paths:
      include: ["**/*.go"]
      exclude: ["**/vendor/**","**/*_test.go"]

  - id: org-go-open-redirect
    message: "Open redirect risk. Validate redirect target against allowlist."
    languages: [go]
    severity: ERROR
    patterns:
      - pattern: http.Redirect($W, $R, $URL, $CODE)
      - metavariable-pattern:
          metavariable: $URL
          pattern-regex: "(?i)(FormValue|Query\\(|PostForm|Param|Header|URL)"
    paths:
      include: ["**/*.go"]
      exclude: ["**/vendor/**","**/*_test.go"]

  - id: org-go-command-injection
    message: "Command injection risk. Avoid shell `sh -c` with user input; use exec.Command with args or whitelist."
    languages: [go]
    severity: ERROR
    patterns:
      - pattern: exec.Command("sh","-c", $CMD)
      - metavariable-pattern:
          metavariable: $CMD
          pattern-regex: "(?i)(FormValue|Query\\(|PostForm|Param|Header|Body|JSON|Bind)"
    paths:
      include: ["**/*.go"]
      exclude: ["**/vendor/**","**/*_test.go"]

  - id: org-go-ssrf-user-controlled-url
    message: "SSRF risk: outbound HTTP request with user-controlled URL. Enforce allowlist/scheme/host validation."
    languages: [go]
    severity: ERROR
    patterns:
      - pattern: http.Get($URL)
      - metavariable-pattern:
          metavariable: $URL
          pattern-regex: "(?i)(FormValue|Query\\(|PostForm|Param|Header|Body|JSON|Bind)"
    paths:
      include: ["**/*.go"]
      exclude: ["**/vendor/**","**/*_test.go"]

  # =========================================================
  # F. PAYMENTS / MONEY / OTP
  # =========================================================

  - id: org-go-money-float
    message: "Monetary values must not use float. Use decimal or int64 (minor units)."
    languages: [go]
    severity: ERROR
    pattern-either:
      - pattern-regex: 'type\\s+\\w+\\s+struct\\s*{[^}]*\\b(Amount|Balance|Price|Nominal)\\s+float64'
      - pattern-regex: '\\b(Amount|Balance|Price|Nominal)\\s*:=\\s*\\d+\\.\\d+'
      - pattern-regex: 'var\\s+\\w*(Amount|Balance|Price|Nominal)\\s+float64'
    paths:
      include: ["**/*.go"]
      exclude: ["**/vendor/**","**/*_test.go"]

  - id: org-go-otp-bypass
    message: "OTP bypass/backdoor detected. Remove test shortcuts like otp == \"0000\"."
    languages: [go]
    severity: ERROR
    pattern-either:
      - pattern: if $OTP == "0000" { ... }
      - pattern: if "0000" == $OTP { ... }
    metavariable-pattern:
      - metavariable: $OTP
        pattern-regex: "(?i)(otp|pin|code|passcode)"
    paths:
      include: ["**/*.go"]
      exclude: ["**/vendor/**","**/*_test.go"]

  # Idempotency (heuristic): POST /transfer handler tanpa idempotency header usage
  - id: org-go-idempotency-missing
    message: "Transfers/payments should enforce Idempotency-Key to avoid double-charge (heuristic)."
    languages: [go]
    severity: INFO
    patterns:
      - pattern-inside: |
          func $H($W http.ResponseWriter, $R *http.Request){ ... }
      - pattern-either:
          - pattern: $R.Method == "POST"
          - pattern: $ROUTER.POST("/transfer", ...)
    pattern-not: $R.Header.Get("Idempotency-Key")
    paths:
      include: ["**/*.go"]
      exclude: ["**/vendor/**","**/*_test.go"]